# Архитектура приложения

В этом проекте применил принципы SOLID и современные паттерны проектирования для создания чистой и масштабируемой архитектуры.

## Структура проекта

### Слой репозиториев

Расположение: `repositories/`

Создал базовые интерфейсы и их реализации для работы с данными:
- `BaseRepositoryInterface.php` - базовый интерфейс для всех репозиториев
- `VacancyRepositoryInterface.php` - интерфейс для работы с вакансиями  
- `UserRepositoryInterface.php` - интерфейс для работы с пользователями

Каждый репозиторий отвечает только за работу с данными одной сущности. Контроллеры зависят от интерфейсов, а не от конкретных реализаций.

### Сервисный слой

Расположение: `services/`

Вся бизнес-логика вынесена в сервисы:
- `VacancyService.php` - логика работы с вакансиями
- `AuthService.php` - логика аутентификации
- `TokenService.php` - управление токенами доступа
- `RbacService.php` - управление правами доступа

Каждый сервис отвечает за определенную область бизнес-логики и легко расширяется через интерфейсы.

### Тонкие контроллеры

Применил принцип "тонкого" контроллера - они содержат минимум логики и отвечают только за:
- Получение данных из запроса
- Вызов соответствующего сервиса
- Формирование ответа
- Обработку HTTP статусов

Пример рефакторинга контроллера:

**Было:**
```php
public function actionCreate(): array
{
    $model = new Vacancy();
    $model->load(Yii::$app->getRequest()->getBodyParams(), '');
    
    if ($model->save()) {
        Yii::$app->response->setStatusCode(201);
        return ['id' => $model->id, 'result' => 'success'];
    }
    
    Yii::$app->response->setStatusCode(422);
    return ['result' => 'error', 'errors' => $model->errors];
}
```

**Стало:**
```php
public function actionCreate(): array
{
    $data = Yii::$app->getRequest()->getBodyParams();
    $result = $this->vacancyService->create($data);
    
    if ($result['success']) {
        Yii::$app->response->setStatusCode(201);
        return ['id' => $result['data']['id'], 'result' => 'success'];
    }
    
    Yii::$app->response->setStatusCode(422);
    return ['result' => 'error', 'errors' => $result['errors']];
}
```

### Управление зависимостями

Использую Service Factory для простого и надежного управления зависимостями:

```php
class ServiceFactory
{
    private static ?VacancyServiceInterface $vacancyService = null;
    
    public static function getVacancyService(): VacancyServiceInterface
    {
        if (self::$vacancyService === null) {
            $vacancyRepository = new VacancyRepository();
            self::$vacancyService = new VacancyService($vacancyRepository);
        }
        return self::$vacancyService;
    }
}
```

Этот подход не зависит от особенностей Yii2 DI, легко тестируется и позволяет явно управлять зависимостями.

### Модели данных

Разделил ответственность между моделями:
- `Vacancy.php` - модель вакансий с валидацией
- `User.php` - оригинальная модель пользователя
- `UserEntity.php` - новая модель для работы с базой данных
- `PersonalAccessToken.php` - модель токенов доступа
- `LoginForm.php` - форма логина только с валидацией

## API Endpoints

Все API endpoints используют новую архитектуру:

**Аутентификация:**
- `POST /api/v1/auth/login` - вход в систему
- `POST /api/v1/auth/logout` - выход
- `POST /api/v1/auth/logout-all` - выход из всех устройств
- `POST /api/v1/auth/refresh` - обновление токена
- `GET /api/v1/auth/me` - информация о пользователе
- `GET /api/v1/auth/tokens` - список токенов

**Вакансии:**
- `GET /api/v1/vacancies` - список вакансий
- `GET /api/v1/vacancies/{id}` - конкретная вакансия
- `POST /api/v1/vacancies` - создание вакансии
- `PUT /api/v1/vacancies/{id}` - обновление вакансии
- `DELETE /api/v1/vacancies/{id}` - удаление вакансии
- `GET /api/v1/vacancies/search` - поиск вакансий
- `GET /api/v1/vacancies/stats` - статистика по вакансиям

## Система аутентификации

Реализовал систему токенов доступа аналогичную Laravel Sanctum:
- Токены хранятся в базе данных в хешированном виде
- Поддержка срока действия токенов
- Система прав доступа (abilities)
- Отслеживание последнего использования
- Возможность отзыва токенов

## Миграции базы данных

Создал необходимые миграции:
- `m241201_000000_create_user_table.php` - таблица пользователей
- `m241201_000001_add_status_to_vacancy_table.php` - статус вакансий
- `m250901_184435_create_vacancy_table.php` - таблица вакансий
- `m250902_110712_create_personal_access_tokens_table.php` - токены доступа
- `m250902_220502_create_rbac_tables.php` - система ролей

Запуск миграций:
```bash
./yii migrate
```

## Преимущества архитектуры

**Соблюдение SOLID принципов:**
- Каждый класс имеет одну ответственность
- Легко расширяется новой функциональностью
- Зависимость от абстракций, а не от конкретных классов

**Тестируемость:**
- Все компоненты можно покрыть unit-тестами
- Зависимости мокаются через интерфейсы
- Бизнес-логика изолирована в сервисах

**Масштабируемость:**
- Легко добавлять новые сущности
- Простое расширение функциональности
- Четкое разделение слоев

**Поддерживаемость:**
- Код легко читается и понимается
- Изменения в одном слое не влияют на другие
- Четкая структура проекта

## Пример добавления функционала

Для демонстрации расширяемости добавил endpoint статистики по вакансиям:

1. Расширил интерфейс репозитория методом `getStatistics()`
2. Реализовал метод в `VacancyRepository`
3. Добавил бизнес-логику в `VacancyService`
4. Создал action в контроллере
5. Настроил маршрут

Благодаря четкой архитектуре это заняло минимум времени и не нарушило существующий код.

## Планы по развитию

1. Добавление DTO для передачи данных между слоями
2. Реализация паттерна Specification для сложных запросов
3. Система событий для обработки доменных событий
4. Внедрение CQRS для разделения команд и запросов
5. Кеширование на уровне сервисов
6. Детальное логирование операций
